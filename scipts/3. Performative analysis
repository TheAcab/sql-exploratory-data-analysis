--Analyse the yearly performance of products by comparing each products sales 
--to both its average sales performance and the previous years sales

with yearly_product_sales as																			--1. this function creates a query with in a query

	(select 
	year (f.order_date) as order_year,
	p.product_name,
	sum(f.sales_amount) as current_sales
	from gold.fact_sales f

	left join gold.dim_products p
	on f.product_key = p.product_key

	where f.order_date is not null
	group by
	year(f.order_date),
	p.product_name)

select																													--2. this is the follow up query
order_year,
product_name,
current_sales,
avg(current_sales) over (partition by product_name) avg_sales,
current_sales - AVG (current_sales) over (partition by product_name) as diff_avg,
case when current_sales - avg(current_sales) over (partition by product_name) > 0 then 'Above avg'
		  when current_sales - avg(current_sales) over (partition by product_name) < 0 then 'Below avg' 
		  else 'Avg'
end avg_change,
-- Year over Year
lag(current_sales) 
over (partition by product_name order by order_year) py_sales, --to access data from a previous row within the same result set
current_sales - lag(current_sales) over (partition by product_name order by order_year) as diff_py,

case when current_sales - lag(current_sales) over (partition by product_name order by order_year) > 0 then 'Increase'
		  when current_sales - lag(current_sales) over (partition by product_name order by order_year) < 0 then 'Decrease' 
		  else 'No Change'
end avg_change

from yearly_product_sales

order by product_name, order_year																--3. the entire scrip must be run to produce a result
